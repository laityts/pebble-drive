name: Deploy PebbleDrive

on:
  # push:
    # branches: [ main ]
  workflow_dispatch:
    inputs:
      max_file_size:
        description: 'Max file size (MB) for simple upload'
        required: false
        default: '1000'
        type: choice
        options:
          - '100'
          - '200'
          - '500'
          - '1000'
      storage_quota:
        description: 'Storage quota (GB)'
        required: false
        default: '10'
        type: choice
        options:
          - '10'
          - '50'
          - '100'
          - '500'
      upload_rate_limit:
        description: 'Upload rate limit (per hour)'
        required: false
        default: '200'
        type: choice
        options:
          - '20'
          - '50'
          - '100'
          - '200'
      pages_project_name:
        description: 'Cloudflare Pages project name'
        required: false
        default: 'pebble-drive'
        type: string

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    name: Deploy Backend (Workers)

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Backend Dependencies
      run: |
        cd backend
        npm ci

    - name: Verify and Configure Backend
      run: |
        cd backend
        echo "ğŸ” éªŒè¯åç«¯é…ç½®..."

        # 1. å¤åˆ¶ç¤ºä¾‹é…ç½®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f wrangler.toml ]; then
          echo "ğŸ“‹ ä»ç¤ºä¾‹é…ç½®åˆ›å»º wrangler.toml..."
          cp wrangler.toml.example wrangler.toml
        fi

        # 2. è·å–æˆ–åˆ›å»º D1 æ•°æ®åº“
        echo "ğŸ—„ï¸ æ£€æŸ¥ D1 æ•°æ®åº“..."
        DB_ID=$(npx wrangler d1 list | grep pebble-drive-db | awk '{print $2}' || echo "")

        if [ -z "$DB_ID" ]; then
          echo "âš ï¸ æœªæ‰¾åˆ°æ•°æ®åº“ pebble-drive-dbï¼Œæ­£åœ¨åˆ›å»º..."
          DB_ID=$(npx wrangler d1 create pebble-drive-db --json | jq -r '.database_id')
          echo "âœ… æ•°æ®åº“åˆ›å»ºæˆåŠŸ: $DB_ID"
        else
          echo "âœ… æ‰¾åˆ°æ•°æ®åº“ ID: $DB_ID"
        fi

        # æ›´æ–° wrangler.toml ä¸­çš„ database_id
        if [[ "$OSTYPE" == "darwin"* ]]; then
          sed -i '' "s/database_id = \".*\"/database_id = \"$DB_ID\"/" wrangler.toml
        else
          sed -i "s/database_id = \".*\"/database_id = \"$DB_ID\"/" wrangler.toml
        fi

        # 4. æ›´æ–°é…ç½®å‚æ•°ï¼ˆå¦‚æœé€šè¿‡ workflow_dispatch æ‰‹åŠ¨è§¦å‘ï¼‰
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸ”§ åº”ç”¨ç”¨æˆ·è‡ªå®šä¹‰é…ç½®..."

          MAX_FILE_SIZE="${{ github.event.inputs.max_file_size }}"
          STORAGE_QUOTA="${{ github.event.inputs.storage_quota }}"
          UPLOAD_LIMIT="${{ github.event.inputs.upload_rate_limit }}"

          if [ -n "$MAX_FILE_SIZE" ]; then
            sed -i "s/MAX_FILE_SIZE_MB = \".*\"/MAX_FILE_SIZE_MB = \"$MAX_FILE_SIZE\"/" wrangler.toml
            echo "  âœ“ MAX_FILE_SIZE_MB = $MAX_FILE_SIZE"
          fi

          if [ -n "$STORAGE_QUOTA" ]; then
            sed -i "s/STORAGE_QUOTA_GB = \".*\"/STORAGE_QUOTA_GB = \"$STORAGE_QUOTA\"/" wrangler.toml
            echo "  âœ“ STORAGE_QUOTA_GB = $STORAGE_QUOTA"
          fi

          if [ -n "$UPLOAD_LIMIT" ]; then
            sed -i "s/UPLOAD_RATE_LIMIT = \".*\"/UPLOAD_RATE_LIMIT = \"$UPLOAD_LIMIT\"/" wrangler.toml
            echo "  âœ“ UPLOAD_RATE_LIMIT = $UPLOAD_LIMIT"
          fi
        fi

        echo "âœ… åç«¯é…ç½®éªŒè¯å®Œæˆ"
        cat wrangler.toml
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Deploy Backend to Cloudflare Workers
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        workingDirectory: 'backend'

    - name: Initialize Database Schema
      run: |
        cd backend
        echo "ğŸ—ƒï¸ åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„..."
        npx wrangler d1 execute pebble-drive-db --file=./migrations/schema.sql || echo "âš ï¸ æ•°æ®åº“è¡¨å·²å­˜åœ¨æˆ–åˆå§‹åŒ–å¤±è´¥ï¼ˆå¯èƒ½å·²å­˜åœ¨ï¼‰"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Backend Deployment Success
      run: |
        echo "âœ… åç«¯éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸŒ Worker å·²éƒ¨ç½²ï¼ŒURL å°†åœ¨ä¸‹ä¸€æ­¥è·å–"

  deploy-frontend:
    runs-on: ubuntu-latest
    name: Deploy Frontend (Pages)
    needs: deploy-backend

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm ci

    - name: Get Worker URL
      id: worker-url
      run: |
        cd backend
        # ä» wrangler.toml è·å– worker åç§°
        WORKER_NAME=$(grep '^name = ' wrangler.toml | sed 's/name = "\(.*\)"/\1/')

        # è·å– Cloudflare è´¦æˆ·çš„å­åŸŸå
        SUBDOMAIN=$(npx wrangler whoami 2>/dev/null | grep 'subdomain' | awk '{print $2}' || echo "")

        if [ -n "$SUBDOMAIN" ]; then
          WORKER_URL="https://${WORKER_NAME}.${SUBDOMAIN}.workers.dev"
        else
          # å›é€€ï¼šä½¿ç”¨é»˜è®¤æ ¼å¼
          WORKER_URL="https://${WORKER_NAME}.workers.dev"
        fi

        echo "worker_url=${WORKER_URL}" >> $GITHUB_OUTPUT
        echo "âœ… Worker URL: ${WORKER_URL}"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Configure Pages Functions
      run: |
        cd frontend
        echo "âš™ï¸ é…ç½® Pages Functions ä»£ç†..."

        # å¤åˆ¶é…ç½®æ¨¡æ¿
        if [ -f wrangler.toml.example ]; then
          cp wrangler.toml.example wrangler.toml
          echo "âœ… å·²åˆ›å»º wrangler.toml"
        fi

        # æ›´æ–° BACKEND_URL
        if [[ "$OSTYPE" == "darwin"* ]]; then
          sed -i '' "s|BACKEND_URL = \".*\"|BACKEND_URL = \"${{ steps.worker-url.outputs.worker_url }}\"|g" wrangler.toml
        else
          sed -i "s|BACKEND_URL = \".*\"|BACKEND_URL = \"${{ steps.worker-url.outputs.worker_url }}\"|g" wrangler.toml
        fi

        echo "âœ… Pages Functions é…ç½®å®Œæˆ"
        echo "   BACKEND_URL: ${{ steps.worker-url.outputs.worker_url }}"

    - name: Build Frontend
      run: |
        cd frontend
        echo "ğŸ—ï¸ æ„å»ºå‰ç«¯..."
        echo "ğŸ“¡ API åœ°å€: (ä½¿ç”¨ Pages Functions ä»£ç†)"
        echo "ğŸ” Turnstile Site Key: ${TURNSTILE_SITE_KEY:0:10}..."
        npm run build

        # ğŸ”´ å…³é”®æ­¥éª¤ï¼šå¤åˆ¶ Pages Functions åˆ°æ„å»ºäº§ç‰©
        echo "ğŸ“¦ å¤åˆ¶ Pages Functions..."
        cp -r functions dist/_functions
        echo "âœ… Functions å¤åˆ¶å®Œæˆï¼ˆå¤åˆ¶åˆ° dist/_functionsï¼‰"
      env:
        VITE_API_BASE_URL: ''
        VITE_TURNSTILE_SITE_KEY: ${{ secrets.TURNSTILE_SITE_KEY }}

    - name: Verify Build Output
      run: |
        cd frontend
        echo "ğŸ” éªŒè¯æ„å»ºè¾“å‡º..."

        # æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®æ³¨å…¥ï¼ˆAPI_BASE_URL åº”ä¸ºç©ºå­—ç¬¦ä¸²ï¼‰
        if grep -q "ENV_API_BASE_URL = ''" dist/index.html; then
          echo "âœ… API_BASE_URL æ³¨å…¥æˆåŠŸï¼ˆç©ºå­—ç¬¦ä¸²ï¼Œä½¿ç”¨ Pages Functions ä»£ç†ï¼‰"
        else
          echo "âŒ API_BASE_URL æ³¨å…¥å¤±è´¥"
          exit 1
        fi

        # ğŸ”´ å…³é”®éªŒè¯ï¼šæ£€æŸ¥ Pages Functions æ˜¯å¦å¤åˆ¶æˆåŠŸ
        if [ -d "dist/_functions" ]; then
          echo "âœ… Pages Functions ç›®å½•å­˜åœ¨ï¼ˆdist/_functionsï¼‰"
          echo "   å‡½æ•°åˆ—è¡¨:"
          ls -la dist/_functions/

          # ç»Ÿè®¡ .js æ–‡ä»¶æ•°é‡
          FUNCTIONS_COUNT=$(find dist/_functions -name "*.js" | wc -l | tr -d ' ')
          echo "âœ… æ‰¾åˆ° $FUNCTIONS_COUNT ä¸ª Functions æ–‡ä»¶"

          # ğŸ”´ å¢å¼ºéªŒè¯ï¼šæ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo ""
          echo "ğŸ” éªŒè¯å…³é”® Functions æ–‡ä»¶..."

          MISSING_FILES=0

          # æ£€æŸ¥ API ä»£ç†å‡½æ•°
          if [ ! -f "dist/_functions/api/[[path]].js" ]; then
            echo "âŒ ç¼ºå¤±å…³é”®æ–‡ä»¶ï¼šdist/_functions/api/[[path]].js"
            MISSING_FILES=$((MISSING_FILES + 1))
          else
            FILE_SIZE=$(stat -c%s "dist/_functions/api/[[path]].js" 2>/dev/null || stat -f%z "dist/_functions/api/[[path]].js" 2>/dev/null)
            if [ "$FILE_SIZE" -lt 100 ]; then
              echo "âŒ æ–‡ä»¶è¿‡å°ï¼ˆå¯èƒ½æŸåï¼‰ï¼šdist/_functions/api/[[path]].js (${FILE_SIZE} bytes)"
              MISSING_FILES=$((MISSING_FILES + 1))
            else
              echo "âœ… API ä»£ç†å‡½æ•°å­˜åœ¨ (${FILE_SIZE} bytes)"
            fi
          fi

          # æ£€æŸ¥åˆ†äº«é“¾æ¥ä»£ç†å‡½æ•°
          if [ ! -f "dist/_functions/share/[[token]].js" ]; then
            echo "âŒ ç¼ºå¤±å…³é”®æ–‡ä»¶ï¼šdist/_functions/share/[[token]].js"
            MISSING_FILES=$((MISSING_FILES + 1))
          else
            FILE_SIZE=$(stat -c%s "dist/_functions/share/[[token]].js" 2>/dev/null || stat -f%z "dist/_functions/share/[[token]].js" 2>/dev/null)
            if [ "$FILE_SIZE" -lt 100 ]; then
              echo "âŒ æ–‡ä»¶è¿‡å°ï¼ˆå¯èƒ½æŸåï¼‰ï¼šdist/_functions/share/[[token]].js (${FILE_SIZE} bytes)"
              MISSING_FILES=$((MISSING_FILES + 1))
            else
              echo "âœ… åˆ†äº«é“¾æ¥ä»£ç†å‡½æ•°å­˜åœ¨ (${FILE_SIZE} bytes)"
            fi
          fi

          # æ£€æŸ¥ä¸‹è½½ä»£ç†å‡½æ•°
          if [ ! -f "dist/_functions/download/[[token]].js" ]; then
            echo "âŒ ç¼ºå¤±å…³é”®æ–‡ä»¶ï¼šdist/_functions/download/[[token]].js"
            MISSING_FILES=$((MISSING_FILES + 1))
          else
            FILE_SIZE=$(stat -c%s "dist/_functions/download/[[token]].js" 2>/dev/null || stat -f%z "dist/_functions/download/[[token]].js" 2>/dev/null)
            if [ "$FILE_SIZE" -lt 100 ]; then
              echo "âŒ æ–‡ä»¶è¿‡å°ï¼ˆå¯èƒ½æŸåï¼‰ï¼šdist/_functions/download/[[token]].js (${FILE_SIZE} bytes)"
              MISSING_FILES=$((MISSING_FILES + 1))
            else
              echo "âœ… ä¸‹è½½ä»£ç†å‡½æ•°å­˜åœ¨ (${FILE_SIZE} bytes)"
            fi
          fi

          # éªŒè¯ç»“æœ
          if [ "$MISSING_FILES" -gt 0 ]; then
            echo ""
            echo "âŒâŒâŒ Functions éªŒè¯å¤±è´¥ï¼š$MISSING_FILES ä¸ªå…³é”®æ–‡ä»¶ç¼ºå¤±æˆ–æŸå"
            echo ""
            echo "âš ï¸ è¿™å°†å¯¼è‡´ä¸¥é‡çš„å®‰å…¨é—®é¢˜ï¼š"
            echo "   - åˆ†äº«é“¾æ¥å¯ä»¥ç»•è¿‡ä¸‹è½½æ¬¡æ•°é™åˆ¶"
            echo "   - è¿‡æœŸé“¾æ¥ä¾ç„¶å¯ä»¥è®¿é—®"
            echo "   - å¯†ç ä¿æŠ¤å¤±æ•ˆ"
            echo "   - API è¯·æ±‚å¯èƒ½æš´éœ²åç«¯åœ°å€"
            echo ""
            echo "ğŸ”§ è§£å†³æ–¹æ³•ï¼š"
            echo "   1. æ£€æŸ¥ frontend/functions/ ç›®å½•æ˜¯å¦å­˜åœ¨è¿™äº›æ–‡ä»¶"
            echo "   2. æ£€æŸ¥æ„å»ºæ­¥éª¤ä¸­çš„ 'cp -r functions dist/_functions' æ˜¯å¦æ‰§è¡Œ"
            echo "   3. æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼ˆæ³¨æ„ [[path]] å’Œ [[token]] è¯­æ³•ï¼‰"
            exit 1
          fi

          echo ""
          echo "âœ…âœ…âœ… æ‰€æœ‰å…³é”® Functions æ–‡ä»¶éªŒè¯é€šè¿‡"
        else
          echo "âŒ Pages Functions ç›®å½•ä¸å­˜åœ¨ï¼ˆdist/_functionsï¼‰"
          echo "âš ï¸ è¿™å°†å¯¼è‡´ä¸¥é‡çš„å®‰å…¨é—®é¢˜ï¼š"
          echo "   - åˆ†äº«é“¾æ¥å¯ä»¥ç»•è¿‡ä¸‹è½½æ¬¡æ•°é™åˆ¶"
          echo "   - è¿‡æœŸé“¾æ¥ä¾ç„¶å¯ä»¥è®¿é—®"
          echo "   - å¯†ç ä¿æŠ¤å¤±æ•ˆ"
          exit 1
        fi

        if grep -q "VITE_TURNSTILE_SITE_KEY = '${{ secrets.TURNSTILE_SITE_KEY }}'" dist/index.html; then
          echo "âœ… TURNSTILE_SITE_KEY æ³¨å…¥æˆåŠŸ"
        else
          echo "âš ï¸ TURNSTILE_SITE_KEY æ³¨å…¥å¤±è´¥ï¼ˆå¯èƒ½æœªé…ç½®ï¼‰"
        fi

    - name: Deploy Frontend to Cloudflare Pages
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: pages deploy dist --project-name=${{ github.event.inputs.pages_project_name || secrets.PAGES_PROJECT_NAME || 'pebble-drive' }}
        workingDirectory: 'frontend'

    - name: Deployment Complete
      run: |
        echo "ğŸ‰ PebbleDrive å®Œæ•´éƒ¨ç½²æˆåŠŸï¼"
        echo ""
        echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯ï¼š"
        echo "   ğŸ”§ åç«¯ API: ${{ steps.worker-url.outputs.worker_url }}"
        echo "   ğŸ¨ å‰ç«¯åº”ç”¨: æŸ¥çœ‹ä¸Šæ–¹ Pages éƒ¨ç½²è¾“å‡ºè·å– URL"
        echo ""
        echo "âš ï¸  é‡è¦æé†’ï¼šé¦–æ¬¡éƒ¨ç½²åéœ€è¦é…ç½® Worker Secrets"
        echo ""
        echo "ğŸ“Œ å¿…éœ€çš„ Worker Secretsï¼ˆåç«¯å¯†é’¥ï¼‰ï¼š"
        echo "   1. AUTH_PASSWORD          - ç™»å½•å¯†ç ï¼ˆå¿…éœ€ï¼‰"
        echo "   2. AUTH_TOKEN_SECRET      - JWT å¯†é’¥ï¼Œ32ä½éšæœºå­—ç¬¦ä¸²ï¼ˆå¿…éœ€ï¼‰"
        echo "   3. TURNSTILE_SECRET_KEY   - Turnstile éªŒè¯å¯†é’¥ï¼ˆå¿…éœ€ï¼‰"
        echo ""
        echo "ğŸ”§ é…ç½®å‘½ä»¤ï¼ˆåœ¨æœ¬åœ°è¿è¡Œï¼‰ï¼š"
        echo "   cd backend"
        echo "   echo 'your-password' | npx wrangler secret put AUTH_PASSWORD"
        echo "   openssl rand -base64 32 | npx wrangler secret put AUTH_TOKEN_SECRET"
        echo "   echo 'your-turnstile-secret' | npx wrangler secret put TURNSTILE_SECRET_KEY"
        echo ""
        echo "ğŸ“Œ å¿…éœ€çš„ GitHub Secretsï¼ˆå‰ç«¯æ„å»ºï¼‰ï¼š"
        echo "   CLOUDFLARE_API_TOKEN      - å·²é…ç½® âœ…"
        echo "   CLOUDFLARE_ACCOUNT_ID     - å·²é…ç½® âœ…"
        echo "   TURNSTILE_SITE_KEY        - Turnstile ç«™ç‚¹å¯†é’¥"
        echo "   PAGES_PROJECT_NAME        - Pages é¡¹ç›®åï¼ˆå¯é€‰ï¼Œé»˜è®¤ pebble-driveï¼‰"
        echo ""
        echo "ğŸ”‘ è·å– Turnstile å¯†é’¥ï¼š"
        echo "   è®¿é—® https://dash.cloudflare.com/?to=/:account/turnstile"
        echo "   åˆ›å»ºç«™ç‚¹åè·å– Site Key å’Œ Secret Key"
        echo ""
        echo "ğŸ“ æ›´å¤šé…ç½®è¯´æ˜ï¼š"
        echo "   - æŸ¥çœ‹ backend/wrangler.toml è°ƒæ•´æ–‡ä»¶å¤§å°é™åˆ¶ã€é€Ÿç‡é™åˆ¶ç­‰"
        echo "   - æ‰€æœ‰ç¯å¢ƒå˜é‡éƒ½åœ¨ wrangler.toml [vars] éƒ¨åˆ†"
